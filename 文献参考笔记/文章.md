### 1、基于微服务的金融贷后系统的设计与实现

> etcd：高可用强一致性的服务发现存储仓库

##### 摘要

在gRPC、etcd、Kong网关基础上搭建项目的微服务框架，再对gRPC包进行封装和二次开发，以Sidecar模式加入gRPC gateway和gRPCproxy，使应用服务和辅助服务分离，HTTP请求转为gRPC请求。

**微服务**：微服务架构按业务功能划分，每个服务都具备特定的功能，易于开发以及维护；每个独立的微服务可以由不同的语言基于不同的平台开发，灵活性较好，子服务可独立部署，能够实现可持续集成及交付；单个微服务出现问题不会影响系统其他服务的运行，并且可以实现动态按需实时扩展。

微服务的核心在于基于面向服务的思想，对传统大型应用系统进行功能
分解，推动细粒度服务的使用。微服务架构则指根据应用系统的业务需求，
通过对预定义的微服务进行重组而形成企业级应用的分布式体系结构。它主
要将传统概念上的单体应用在功能、数据等方面进行分解，划分为多个具有
明确边界并可被自由重组的小规模子服务。这些子服务间采用轻量级通信方
式实现交互、协作，每个服务都有自己的数据库并可在独立进程中被部署、
运行等，服务之间保持技术异构性，可由不同的团队选择合适的工具、语言
进行开发。 
与单体架构相比，微服务架构的优势有以下几点： 
(1)微服务按业务功能划分，每个服务都具备特定的功能，易于开发、维
护等。(2)每个独立的微服务可以由不同的语言基于不同的平台开发，灵活性
较好。(3)子服务可独立部署，能够实现可持续集成及交付。(4)容错能力强，
单个微服务出现问题并不会影响系统其他服务的运行(5)拓展性好，可按需实
时扩展，功能更新迭代快等

<u>**国内**</u>相关文献中对于微服务的研究工作主要集中在将原有的系统微服务
化或者利用微服务框架搭建新的系统，专注于功能的实现，解决微服务化过
程中遇到的一些问题。

**<u>国外</u>**相关文献中对于微服务技术的研究工作主要分为四个方面，第一方
面介绍微服务架构概念，并结合具体工程来说明优势，第二方面开发微服务
相关组件或工具，实现微服务架构下的某些关键功能或者组件，第三方面评
估比较不同微服务架构的性能，第四方面讨论企业从单体架构转变为微服务
架构的优劣势以及要解决的问题。



> 实现**微服务架构** ：
>
> 需要提供服务注册与发现、服务间通信、服务部署等技术；并添加负载均衡、服务网关和容错机制模块保证服务稳定性和安全性。

##### **服务注册与发现**

单个服务运行在docker中时，是以docker服务实例的方式运行，实例是可以克隆、销毁和重定位的，需要一种动态的服务发现机制可以随时定位服务发现。

**服务注册**，就是将提供某个服务的模块信息(通常是这个服务的ip和端口)注册到1个公共的组件上去（比如: zookeeper\consul）。

![img](https://pic2.zhimg.com/80/v2-e0d57ebf56f9743a03f35e297934d9dd_720w.jpg)

伪代码如下：

```
//给User服务申请1个独有的专属名字
UserNameServer = NameServer->apply('User');

//User服务下的6台docker实例启动后，都去注册自己
UserServer1 = {ip: 192.178.1.1, port: 3445}
UserNameServer->register(UserServer1);

......

UserServer6 = {ip: 192.178.1.6, port: 3445}
UserNameServer->register(UserServer6);

//给Order服务申请1个独有的专属名字
OrderNameServer = NameServer->apply('Order');

//开始注册
OrderServer1 = {ip: 192.178.1.1, port: 3446}
OrderNameServer->register(OrderServer1);
```

**服务发现**，就是新注册的这个服务模块能够及时的被其他调用者发现。不管是服务新增和服务删减都能实现自动发现。

<u>Order服务想要User服务相关的信息，，首先向注册集群中心发送请求获取，然后就能收到User服务相关信息。</u>

![img](https://pic4.zhimg.com/80/v2-7e32eeb70fad22a91e7f8d97088d606b_720w.jpg)

伪代码如下：

```
//服务发现，获取User服务的列表
list = NameServer->getAllServer('User'); 

//list的内容
[
    {
        "ip": "192.178.1.1",
        "port": 3445
    },
    {
        "ip": "192.178.1.2",
        "port": 3445
    },
    ......
    {
        "ip": "192.178.1.6",
        "port": 3445
    }
]
```

##### **服务网关** 

##### **负载均衡**

##### **服务容错**

##### **服务部署与通信**

#### gRPC框架

gRPC 也是基于以下理念：定义一个服务，指定其能够被远程调用的方法（包含参数和返回类型）。在服务端实现这个接口，并运行一个 gRPC 服务器来处理客户端调用。在客户端拥有一个存根能够像服务端一样的方法。 

1. 基于 HTTP 2.0 
2. 使用 ProtoBuf  
3. 多语言支持

**gRPC负载均衡**

（1）服务启动后 gRPC 客户端向命名服务器发出名称解析请求，名称将
解析为一个或多个 IP 地址，每个 IP 地址标示它是服务器地址还是负载均衡
器地址，以及标示要使用那个客户端负载均衡策略或服务配置。 

（2）客户端实例化负载均衡策略，如果解析返回的地址是负载均衡器地
址，则客户端将使用 gRPClb 策略，否则客户端使用服务配置请求的负载均
衡策略。 

（3）负载均衡策略为每个服务器地址创建一个子通道。 

（4）当有 RPC 请求时，负载均衡策略决定那个子通道即 gRPC 服务器
将接收请求，当可用服务器为空时客户端的请求将被阻塞。



#### 技术架构 

##### 服务接入层

###### 接入Kong网关

项目在服务接入层对请求实行统一接入和管理，使用 Kong 网关作为客户端和消费端接入微服务的唯一入口，在网关可以进行统一的服务接入，流量控制，安全防护，限流熔断以及性能监控，使服务本身可以更专注于自己的逻辑实现。同时，只需简单的配置即可将开发的服务发布出去。因此服务的开发者便捷地对外提供服务。 

Kong 是一个基于 Nginx/OpenResty 的开源 API 网关，使用 lua 进行插件开发，其主要特点有,基于 Nginx，稳定性高,节点水平扩展，基于 REST API，通过 REST API 配置服务，路由及插件，可以从繁琐的配置文件中解放出来，支持熔断，限流，健康检查以及提供了实时监控功能。 

项目在请求经过 Kong 网关时，统一进行请求参数签名、Prometheus 监控（针对请求速率，请求时延，签名校验失败次数等进行统计）以及统一的token 检验和验签。

###### 部署gRPC proxy以及gRPC-gateway

使用开源中间件 gRPC gateway+gRPC proxy，通过 Sidecar 方式部署 gRPC proxy 与 gRPC gateway，能够实现服务自动发现。







### 2、微服务体系结构实现框架综述

##### 摘要

论述面向服务体系结构SOA、 Web服务及微服务相关概念并作比较； 给出微服务体系结构实践中的关键技术以及核心功能模块； 分析对比主流微服务体系结构实施框架及其核心部件的特征和差异； 探讨微服务组合面临的挑战及微服务框架中的服务组合方案。

##### 引言

 **单体架构**存在较多不足。首先，单体应用的代码庞大，代码耦合度高，系统灵活性较差；其次，单体架构受技术限制，所有模块都采用相同技术，难以实现技术协同；第三，单体应用的创建或部署时间较长、成本较高，难以实现持续发布及部署。更为重要的是，单体应用难以被扩展，可伸缩性较差。

 **与Web服务相比**， 微服务更具优势， 例如采用去中心化管理及轻量级容器部署， 提供监控预警及多种高可用容错策略， 服务数据独立且开发自由。

##### Web服务与微服务

**微服务**其核心要义在于基于面向服务的思想， 对传统大型应用系统进行功能分解， 推动细粒度服务的使用。微服务架构（MicroServices Architecture， MSA） 则指根据应用系统的业务需求， 通过对预定义的微服务进行重组而形成企业级应用的分布式体系结构。它主要将传统概念上的单体应用在功能、 数据等方面进行分解， 划分为多个具有明确边界并可被自由重组的小规模子服务。这些子服务间采用轻量级通信方式实现交互、 协作， 每个服务都有自己的数据库并可在独立进程中被部署、 运行等，服务之间保持技术异构性， 可由不同的团队选择合适的工具、 语言进行开发。

 微服务架构的优势在于：（1） 微服务按业务功能划分， 每个服务都具备特定的功能， 易于开发、 维护等；（2） 每个独立的微服务可以由不同的语言基于不同的平台开发， 灵活性较好；（3） 子服务可独立部署， 能够实现可持续集成及交付；（4）容错能力强大，单个微服务出现问题不会影响系统其他服务的运行；（5）可实现动态按需实时扩展等。

**Web服务**重在解决异构资源的整合，通过企业服务总线ESB将不同服务集成到企业应用中；其重量级特性使灵活度降低，不能很好的支持大型企业级应用的持续变更、发布和部署

微服务采用轻量级协议，也没有重量级ESB，去中心化，独立业务功能和独立数据库，单独部署运行在轻量级Docker容器中实现敏捷开发

|          Web服务体系           |           微服务架构            |
| :----------------------------: | :-----------------------------: |
|   企业级， 自顶向下展开实施    |    团队级， 自底向上展开实施    |
| 服务由多个子系统组成， 粒度大  |  系统被拆分为多个服务， 粒度细  |
|   企业服务总线， 集中式开发    |  去中心化管理， 松散的服务架构  |
| 集成方式复杂 （ESB/WSDL/SOAP） | 集成方式简单 （HTTP/REST/JSON） |
|    服务依赖性强， 部署复杂     |    服务彼此独立， 能单独部署    |





### 3、基于RPC的高并发网络通信中负载均衡的研究

高并发指多个用户同时发送请求，此情况下服务器资源利用率相应上升，到达阈值后服务器性能会缓慢下降甚至骤然降低。<u>面对如此海量的并发请求时，后台服务要保持原有即时、流畅、稳定的用户体验</u>，就需要有良好的网络通信架构的支撑，本文选择对 RPC 进行深入研究。

对于大型的网络应用提供商，它所有的网络服务不会部署在同一台服务器中，而是分别部署在不同地域、性能的服务器集群中。服务消费方想要调用另一个服务提供方的服务，开发人员就需要写大量和网络通信相关但与业务无关的多余代码，此方法不但增加了程序的复杂度，同时还容易产生错误。**远程过程调用**（Remote Procedure Call，RPC）的概念就是能让程序开发人员类似于调用本机自身服务一样的方式和效率来调用其它远程服务器中的服务，同时开发人员也不需要在代码中实现具体的网络通信，它能够在一定程度上提升后台间服务互相调用的效率。

**规范的 RPC 请求**一般为服务消费方发起 RPC 请求，服务消费方绑定参数打包发送给服务注册中心，注册中心搜索此服务的相关服务提供方，选择适合的服务提供方，提供方解绑参数再处理请求再绑定参数并打包，最终通过注册中心解绑参数返回给服务消费方；			自从引入了 RPC 技术，其开发的网站架构就具有了可以轻松地平行向外拓展等优点

研究RPC负载均衡中<u>“最快相应算法”、“动态硬件监控”、“加权轮询算法”</u>（加权轮询算法：把来自用户的请求轮流分配给内部的服务器：从服务器1开始，直到服务器N，然后重新开始循环。也可以给每个服务器设定一个固定的权重值，按照权重值来实现轮询）

##### RPC 有以下几个特性

一、普遍性，能支持较为高级的数据结构；二、高性能，减小了时间复杂度，同时也降低了空间复杂度；三、可扩展性，可以轻松地横向拓展，大大提升了系统的健壮性[3, 26, 27]。因此，RPC 框架就是可以让程序开发人员来调用远程进程中代码的一套工具，实现了不使用多线程、Socket 等来开发高性能系统。常用 RPC 框架有谷歌 gRPC、Apache Thrift、阿里巴巴 Dubbo、Redhat Wildfly 等。 

##### gRPC框架

自动对结构化数据进行序列化、反序列化的机制，即 Protobuf (Protocol Buffers)；**通过序列化速度和内存占用等对比，它经常会被用于数据缓存、数据交互、通信方式优化等多方面**

gRPC 是谷歌公司最近公布的开源软件，它基于最新的 HTTP2.0 协议，并支持常见的多种编程语言。HTTP2.0 是基于二进制的 HTTP 协议升级版本，目前各大浏览器都在加快支持的进度。若未来浏览器支持 HTTP2.0，并通过现有开源序列化库比如 Protobuf 等，可以直接和其它语言的服务进行高效交互，这将是 g RPC 最好的使用场景。它的底层网络库基于 Netty，并使用最新的 Netty 5.0.0.Alpha3 的开发版本，所以最新版本针对 HTTP2.0做了很多改进；为了跨语言，g PRC 也和其他常用框架一样，采用了类似原生 IDL（Interface Definition Language）的接口描述语言，利用 Protobuf 项目自带的 protoc 编译器来生成框架代码。

![img](https://upload-images.jianshu.io/upload_images/5522013-a5a60ac7db59909f.png?imageMogr2/auto-orient/strip|imageView2/2/w/763/format/webp)

![img](https://upload-images.jianshu.io/upload_images/5522013-50c9764316493d22.png?imageMogr2/auto-orient/strip|imageView2/2/w/912/format/webp)

##### Thrift框架

##### Dubbo框架

##### 数据缓存模块

因为高并发请求时，短时大量的请求对于负载均衡的实时性要求较高，单纯的关系型数据库服务由于需要连接数据库、读写数据等数据库操作，每次存取都对数据库进行操作 的话开销会很大，并且一个数据库池的连接数到达上限之后，数据库效率还会大大下降。高并发请求时需要高频率地对动态权重值进行更新操作，且中间变化的权重值实际上不需要全部记录只需要控制台留下记录即可，因此，纯数据库模式不适用于本研究，需要使用<u>缓存技术在负载均衡器和数据库之间增加缓存层用来进行数据动态缓存</u>，一段固定时间后更新数据库数据防止断电等意外中断造成的数据丢失。 



### 4、有关远程过程调用的几个重要问题的讨论

RPC中的问题：1、网络传输协议2、类型一致性3、错误处理4、故而问题5、效率问题6、性能问题7、互操作性